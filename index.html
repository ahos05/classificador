<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Classificador (Supabase)</title>
  <style>
    body { font-family: Inter, system-ui, Arial; max-width:720px; margin:32px auto; padding:20px; background:#fafafa; color:#111; }
    h1{ text-align:center; margin-bottom:18px; }
    .card{ background:#fff; padding:18px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:16px; }
    input, textarea, select { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ddd; font-size:15px; box-sizing:border-box; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; margin-top:10px; background:#111; color:#fff; width:100%; }
    .filtros { margin-bottom:12px; }
    .filtros button { width:auto; display:inline-block; margin-right:8px; padding:8px 12px; background:#eee; color:#111; border-radius:8px; border:0; cursor:pointer;}
    .item{ background:#fff; padding:12px; border-radius:10px; margin-bottom:10px; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    .verde{ border-left:6px solid #2ecc71; }
    .vermelho{ border-left:6px solid #e74c3c; }
    small { color:#666; display:block; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Classificador</h1>

  <div class="card">
    <label>Nome</label>
    <input id="nome" placeholder="Digite o nome" />

    <label>Cor</label>
    <select id="cor">
      <option value="verde">Verde</option>
      <option value="vermelho">Vermelho</option>
    </select>

    <label>Observação</label>
    <textarea id="obs" rows="3" placeholder="Observação (opcional)"></textarea>

    <button id="btnSalvar">Salvar</button>
    <small id="status">Conectando ao Supabase...</small>
  </div>

  <div class="filtros">
    <button data-filter="todos">Todos</button>
    <button data-filter="verde">Verdes</button>
    <button data-filter="vermelho">Vermelhos</button>
  </div>

  <h2>Lista</h2>
  <div id="lista"></div>

  <!-- supabase client (UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <script>
    // ---------- COLOQUE AQUI SUA URL E ANON KEY ----------
    const SUPABASE_URL = "https://iqffvvjnzxdvnzkecyyh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxZmZ2dmpuenhkdm56a2VjeXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDQzMTMsImV4cCI6MjA4MDAyMDMxM30.ZSFoR0cMYlmHlAZpiK0VLPb8vZDfs5X3-yuuGk3w1f0";
    // ----------------------------------------------------

    const statusEl = document.getElementById('status');

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('COLE') ) {
      statusEl.textContent = 'Erro: cole SUPABASE_URL e SUPABASE_ANON_KEY no arquivo.';
      statusEl.style.color = 'red';
    }

    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const nomeInput = document.getElementById('nome');
    const corSelect = document.getElementById('cor');
    const obsInput = document.getElementById('obs');
    const listaEl = document.getElementById('lista');
    const btnSalvar = document.getElementById('btnSalvar');

    async function init() {
      try {
        // checar conexão mínima
        const { data, error } = await supabase.from('people').select('id').limit(1);
        if (error) throw error;
        statusEl.textContent = 'Conectado ao Supabase ✅';
        statusEl.style.color = 'green';
      } catch (err) {
        statusEl.textContent = 'Erro ao conectar: ' + (err.message || err);
        statusEl.style.color = 'red';
      }
      await render('todos');
    }

    btnSalvar.addEventListener('click', salvar);
    document.querySelectorAll('.filtros button').forEach(b => b.addEventListener('click', () => {
      render(b.dataset.filter);
    }));

    async function salvar() {
      const name = nomeInput.value.trim();
      const color = corSelect.value;
      const observation = obsInput.value.trim();

      if (!name) return alert('Digite um nome!');

      btnSalvar.disabled = true;
      btnSalvar.textContent = 'Salvando...';

      const payload = { name, color, observation };
      const { data, error } = await supabase.from('people').insert([payload]).select();

      btnSalvar.disabled = false;
      btnSalvar.textContent = 'Salvar';

      if (error) {
        console.error(error);
        alert('Erro ao salvar: ' + (error.message || JSON.stringify(error)));
        return;
      }

      nomeInput.value = '';
      obsInput.value = '';
      render('todos');
    }

    // pega todas entradas, agrupa por nome e conta cores
    async function render(filter) {
      listaEl.innerHTML = 'Carregando...';

      const { data, error } = await supabase
        .from('people')
        .select('id, name, color, observation, created_at')
        .order('created_at', { ascending: false });

      if (error) {
        listaEl.innerHTML = 'Erro ao carregar: ' + (error.message || JSON.stringify(error));
        return;
      }

      // agrupa por nome
      const resumo = {};
      data.forEach(row => {
        const n = row.name.trim();
        if (!resumo[n]) resumo[n] = { verde: 0, vermelho: 0, obs: [] };
        if (row.color === 'verde') resumo[n].verde++;
        else resumo[n].vermelho++;
        if (row.observation) resumo[n].obs.push(row.observation);
      });

      // construir DOM
      listaEl.innerHTML = '';
      const nomes = Object.keys(resumo).sort((a,b) => resumo[b].verde + resumo[b].vermelho - (resumo[a].verde + resumo[a].vermelho));
      nomes.forEach(nome => {
        const item = resumo[nome];
        const corPrincipal = item.verde > item.vermelho ? 'verde' : (item.vermelho > item.verde ? 'vermelho' : 'verde');
        if (filter !== 'todos' && filter !== corPrincipal) return;

        const div = document.createElement('div');
        div.className = 'item ' + corPrincipal;
        div.innerHTML = `<strong>${escapeHtml(nome)}</strong>
                         <div>Verde: ${item.verde} | Vermelho: ${item.vermelho}</div>
                         <div style="margin-top:8px">${item.obs.map(o=>`<div style="font-size:13px;margin-bottom:4px">• ${escapeHtml(o)}</div>`).join('')}</div>`;
        listaEl.appendChild(div);
      });

      if (nomes.length === 0) listaEl.innerHTML = '<em>Sem registros</em>';
    }

    // util: escapar HTML simples
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) }); }

    // inicializa
    init();
  </script>
</body>
</html>
